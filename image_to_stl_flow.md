# 图片到STL文件的完整流程

## 1. **输入与配置阶段**
- **命令行参数解析**：用户通过`python src/main.py`命令输入配置参数，包括输入图片路径、输出目录、物理尺寸、分辨率、喷嘴尺寸等。
- **配置初始化**：系统将命令行参数转换为`StlConfig`对象，包含STL生成的所有配置信息。

## 2. **图像预处理阶段** (`ImageAnalyzer.py`)
- **图像加载**：系统加载输入图像，并将其从BGR色彩空间转换为RGB色彩空间。
- **图像分析**：获取图像基本信息，如尺寸、比例等。
- **像素化处理**：根据配置的分辨率，将图像划分为多个块，每个块的颜色取平均值，生成像素化图像。

## 3. **颜色处理与厚度计算阶段** (`color_mixing.py`)
- **颜色转换**：将像素化图像的RGB颜色转换为CMYK颜色空间。
- **厚度计算**：根据颜色值、灯丝属性和颜色混合算法计算每个颜色通道的厚度。
  - 支持两种模式：亮度校正模式 (`extract_and_invert_channels`) 和线性模式 (`extract_and_invert_channels_linear`)
  - 采用Beer-Lambert定律模拟光的吸收和透射，计算不同颜色层的厚度。

## 4. **STL生成阶段** (`to_stl.py`)
- **基础板生成**：创建一个平面作为3D模型的基础板。
- **颜色层生成**：为每个颜色通道（青色、黄色、品红色、白色）生成对应的3D模型层。
- **网格创建**：使用`create_layer_mesh`函数将高度图转换为STL网格。
  - 为每个像素创建立方体
  - 根据计算的厚度调整立方体的高度
  - 确保模型的朝向符合要求
  - 计算法线向量以确保正确的光照效果。

## 5. **输出与保存阶段**
- **STL集合管理**：将所有生成的STL网格存储在`StlCollection`对象中。
- **文件保存**：将各个颜色层的STL文件保存到指定的输出目录。

## 可选步骤
- **图像显示**：如果用户指定了`--show-images`参数，可以显示原始图像和处理后的图像。
- **中间结果保存**：如果用户指定了`--output-image`参数，可以保存像素化图像。

## 关键技术点
- **颜色混合算法**：结合Beer-Lambert定律和最优化算法，确保颜色还原的准确性。
- **灯丝属性**：考虑不同灯丝的透射距离等参数，确保3D打印的颜色效果。
- **像素到厚度映射**：将图像的像素强度转换为3D模型的厚度，实现灰度/彩色石版画效果。